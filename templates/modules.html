{% extends "Base/base.html" %}
{% block shotcut_operation %}
    {% if modules %}
        <span class="item_create_info">点我<a href="{% url 'new' item='2' %}"><i class="fa fa-pencil operation_link"></i></a>创建新模块
    </span>
    {% endif %}
{% endblock %}
{% block main_content %}
    <div class="custom-main">
        <div class="select-by-dropdown">
            <form class="search-by-project-and-module">
                <select id="project" class="alongside-select" name="project">
                    <option value="" selected>选择项目</option>
                    {% for p in projects %}
                        <option value="{{ p.pk }}">{{ p.name }}</option>
                    {% endfor %}
                </select>
                <input title="Search" value="Go" type="submit" class="button">
            </form>
        </div>
        {% if modules %}
            <div class="col-12 tm-block-col">
                <div class="tm-bg-primary-dark tm-block tm-block-taller tm-block-scroll">
                    <h2 class="tm-block-title">模块列表</h2>
                    <table class="table">
                        <thead>
                        <tr>
                            <th scope="col">所属项目</th>
                            <th scope="col">模块</th>
                            <th scope="col">用例数</th>
                            <th scope="col" colspan="3">操作</th>
                        </tr>
                        </thead>
                        {% csrf_token %}
                        <tbody>
                        {% for m in modules %}
                            <tr class="row-detail">
                                <td><b>{{ m.project.name }}</b></td>
                                <td><b>{{ m.name }}</b></td>
                                <td><b>{{ m.get_cases_count }}</b></td>
                                <td><a href="{% url 'list_case' %}?project={{ m.project.pk }}&module={{ m.pk }}&page=1"
                                       class="fa fa-info-circle operation_link"></a></td>
                                <td><a href="{% url 'edit' item='2' pk=m.pk %}"><i
                                        class="fa fa-edit operation_link"></i></a></td>
                                <td><a href="javascript:void(0)" class="remove_module" id="{{ m.pk }}"><i
                                        class="fa fa-remove operation_link"></i></a></td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div>
                <p><img src="/static/images/img/nothing.png" alt="nothing-img"></p>
                <span>还没有任何模块呢，请先创建<a href="{% url 'new' item='2' %}"><i class="fa fa-pencil fa-3x operation_link"></i></a>一个吧!</span>
            </div>
        {% endif %}
    </div>
    </div>
{% endblock %}

{% block added_script %}
    <script type="application/javascript">
        $(".remove_module").on("click", function () {
            let module_pk = $(this).attr("id");
            layer.msg("将删除该模块<br>确认删除吗?", {
                btn: ["确认", "取消"],
                time: 0,
                yes: function () {
                    $.ajax({
                        type: "DELETE",
                        url: "{% url 'module' %}",
                        data: {"pk": module_pk},
                        success: function (resultData) {
                            let result_message = resultData["msg"];
                            layer.msg(result_message);
                            window.location.href = "{% url 'module' %}";
                        },
                        error: function () {
                            layer.msg("服务器异常，请稍后再试!");
                        }
                    });
                }
            })
        });
        $(".search-by-project-and-module").submit(function (e) {
            e.preventDefault();
            let pro_pk = $("#project").val();
            if (pro_pk === "") {
                layer.msg("请选择项目");
            } else {
                $.ajax({
                    type: "GET",
                    url: "/module/?project=" + pro_pk,
                    contentType: false,
                    processData: false,
                    dataType: 'json',
                    success: function (resultData) {

                        let status = resultData["status"];
                        let ms = resultData["msg"];
                        if (status === 1) {
                            $("tbody").children("tr").remove();
                            for (let item in ms) {
                                $('.table > tbody:last-child').append('<tr class="row-detail">\n' +
                                    '                                <td><b>'+ms[item]["project_name"]+'</b></td>\n' +
                                    '                                <td><b>'+ms[item]["name"]+'</b></td>\n' +
                                    '                                <td><b>'+ms[item]["cases_count"]+'</b></td>\n' +
                                    '                                <td><a href="list_case?project='+ms[item]["project_pk"]+'&module='+item+'&page=1'+'"\n' +
                                    '                                       class="fa fa-info-circle operation_link"></a></td>\n' +
                                    '                                <td><a href="/edit/2/'+item+'"><i\n' +
                                    '                                        class="fa fa-edit operation_link"></i></a></td>\n' +
                                    '                                <td><a href="javascript:void(0)" class="remove_module" id="'+item+'"><i\n' +
                                    '                                        class="fa fa-remove operation_link"></i></a></td>\n' +
                                    '                            </tr>');
                            }
                        } else {
                            layer.msg(ms);
                        }
                    },
                    error: function () {
                        layer.msg("服务器异常，请稍后再试!");
                    }
                })
            }

        })


    </script>
{% endblock %}