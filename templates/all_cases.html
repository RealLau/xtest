{% extends "Base/base.html" %}
{% block added_header %}
    <link rel="stylesheet" href="/static/js/jstree/dist/themes/default/style.min.css"/>
    <link rel="stylesheet" type="text/css" href="/static/css/main.css">
    <link rel="stylesheet" type="text/css" href="/static/js/editor.md-master/css/editormd.min.css">

{% endblock %}
{% block shotcut_operation %}
    <span class="item_create_info"><a id="batch-create-cases-link" href="javascript:void(0)"><i
            class="fa fa-pencil operation_link"></i></a>批量导入用例<sup><a href="javascript:void(0)" id="batch-format"><i
            class="fa fa-info-circle operation_link"></i></a></sup></span>
{% endblock %}
{% block main_content %}
    <div class="center-div">
        <label>
            <input class="search_node" type="text" name="search_text" placeholder="搜索" id="search_node">
        </label>
    </div>
    <div class="custom-main">
        <table style="width: 100%; height: 800px">
            <thead>
            <th>
                全部用例
            </th>
            <th>
                详情
            </th>
            </thead>
            <tr>
                <td>
                    <div id="all-case-tree" class="execution-tree"></div>
                </td>
                <td style="width: 600px;height: 800px">
                    <div class="col-12 tm-block-col">
                        <div class="tm-bg-primary-dark tm-block tm-block-taller tm-block-scroll max-height execution-case-detail"
                             id="case-detail-or-edit-or-new-case-form">
                            {% csrf_token %}
                        </div>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <div class="center-div">
        <button class="operations" id="associate-task">关联到测试任务</button>
    </div>
{% endblock %}

{% block added_script %}
    <script src="/static/js/jstree/dist/jstree.min.js"></script>
    <script src="/static/js/editor.md-master/lib/marked.min.js"></script>
    <script src="/static/js/editor.md-master/lib/prettify.min.js"></script>
    <script src="/static/js/editor.md-master/lib/raphael.min.js"></script>
    <script src="/static/js/editor.md-master/lib/underscore.min.js"></script>
    <script src="/static/js/editor.md-master/lib/sequence-diagram.min.js"></script>
    <script src="/static/js/editor.md-master/lib/flowchart.min.js"></script>
    <script src="/static/js/editor.md-master/lib/jquery.flowchart.min.js"></script>
    <script src="/static/js/editor.md-master/editormd.min.js"></script>
    <script type="application/javascript">
        let csrftoken = Cookies.get('csrftoken');
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
        $("#batch-create-cases-link").on("click", function (e) {
            e.preventDefault();
            layer.open({
                type: 2,
                area: ['400px', '200px'],
                fixed: false, //不固定
                maxmin: true,
                title: "批量导入测试用例(EXCEL)",
                content: "{% url 'batch_create_case' %}",
            });
        });

        function showLoadingAndHideIframe() {
            layer.load(0, {shade: false});
            $(".layui-layer-iframe").hide();
        }

        function closeAllAndRefresh() {
            layer.closeAll();
            window.location.href = "{% url 'list_case' %}";
        }

        $("#batch-format").on("click", function (e) {
            e.preventDefault();
            layer.open({
                type: 2,
                area: ['700px', '300px'],
                fixed: false, //不固定
                maxmin: true,
                title: "格式(EXCEL)",
                content: "{% url 'batch_create_case' %}?example=1",
            });
        });
        let data = '{{ all_data|escapejs }}';
        let parsedData = JSON.parse(unescape(data.replace(/\\u/g, '%u')));
        $('#all-case-tree').jstree({
            'core': {
                'data': parsedData,
                'check_callback': true,
            },
            "plugins": [
                "checkbox", "dnd", "search",
                "state", "types", "contextmenu",
            ],
            "contextmenu": {
                "select_node": false,
                "items": function ($node) {
                    let item_id = $node.id;
                    if ((item_id.includes("case"))) {
                        return {
                            "Detail": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "详情",
                                "icon": "/static/images/img/info.png",
                                "action": function (obj) {
                                    let case_id = item_id.replace("case", "");
                                    $.ajax({
                                        type: "GET",
                                        url: "{% url 'case_detail' %}?pk=" + case_id + "&json_type=1",
                                        success: function (resultData) {
                                            let result_message = resultData["msg"];
                                            let status = resultData.status;
                                            if (status === 1) {

                                                let case_detail_or_edit_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                                if ($(case_detail_or_edit_form).length !== 0) {
                                                    $(case_detail_or_edit_form).remove();
                                                }

                                                let steps_detail = $("#case_detail_steps");
                                                if ($(steps_detail).length !== 0) {
                                                    $(steps_detail).remove();
                                                }
                                                let html_source = '<ol class="case_detail_ol">\n' +
                                                    '                                <li class="case_detail_li">\n' +
                                                    '                                    <p class="case_detail_h4">标题</p>\n' +
                                                    '                                    <p class="case_detail_title"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                                <li class="case_detail_li">\n' +
                                                    '                                    <p class="case_detail_h4">描述</p>\n' +
                                                    '                                    <p class="case_detail_desc"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                                <li class="case_detail_li">\n' +
                                                    '                                    <p class="case_detail_h4">前提条件</p>\n' +
                                                    '                                    <p class="case_detail_preconditions">' +
                                                    '</p>' +
                                                    '                                </li>\n' +
                                                    '                                <li class="case_detail_li">\n' +
                                                    '                                    <p class="case_detail_h4">步骤</p>\n' +
                                                    '                                    <p class="case_detail_p">\n' +
                                                    '                                    </p><div id="layout">\n' +
                                                    '                                    </div>\n' +
                                                    '                                    <p></p>\n' +
                                                    '                                </li>\n' +
                                                    '                                <li class="case_detail_li">\n' +
                                                    '                                    <p class="case_detail_h4">期望结果</p>\n' +
                                                    '                                    <p class="case_detail_expectation"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                                <li class="case_detail_li">\n' +
                                                    '                                    <p class="case_detail_h4">优先级</p>\n' +
                                                    '                                    <p class="case_detail_priority"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                            </ol>';
                                                $("#case-detail-or-edit-or-new-case-form").append(html_source);
                                                $("#layout").append("<div id=\"case_detail_steps\" style=\"width: inherit;margin: 50px;\"></div>");
                                                editormd.markdownToHTML("case_detail_steps", {//注意：这里是上面DIV的id
                                                    htmlDecode: "style,script,iframe",
                                                    emoji: true,
                                                    taskList: true,
                                                    tex: true, // 默认不解析
                                                    flowChart: true, // 默认不解析
                                                    sequenceDiagram: true, // 默认不解析
                                                    codeFold: true,
                                                    markdown: result_message.steps
                                                });
                                                $(".case_detail_title").text(result_message.title);
                                                $(".case_detail_desc").text(result_message.desc);
                                                $(".case_detail_preconditions").text(result_message.preconditions);
                                                $(".case_detail_expectation").text(result_message.expectation);
                                                $(".case_detail_priority").text(result_message.priority);
                                                $(".case_id").val(result_message.case_id);
                                            }

                                        },
                                        error: function () {
                                            layer.msg("服务器异常，请稍后再试!");
                                        }
                                    });
                                }
                            },
                            "edit": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "编辑",
                                "icon": "/static/images/img/edit.png",
                                "action": function (obj) {
                                    let case_id = item_id.replace("case", "");
                                    let case_detail_or_edit_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                    if ($(case_detail_or_edit_form).length !== 0) {
                                        $(case_detail_or_edit_form).remove();
                                    }

                                    let data = '<form class="contact100-form validate-form" enctype="multipart/form-data" id="edit-case-form">\n' +
                                        '    <div class="wrap-input100 validate-input" data-validate="Please enter case title">\n' +
                                        '        <input class="input100" type="text" name="case_title" placeholder="标题*">\n' +
                                        '    </div>\n' +
                                        '<input class="input100" name="case_pk" type="hidden" value="' + case_id + '"' + '>' +
                                        '    <div class="wrap-input100 validate-input">\n' +
                                        '                    <textarea class="input100" name="case_desc" placeholder="描述"\n' +
                                        '                              aria-label="optional"></textarea>\n' +
                                        '    </div>\n' +
                                        '    <div class="wrap-input100">\n' +
                                        '                    <textarea class="input100" name="case_preconditions" placeholder="前提条件"\n' +
                                        '                              aria-label="preconditions"></textarea>\n' +
                                        '    </div>\n' +
                                        '    <div id="steps" data-validate="Please enter case steps">\n' +
                                        '                    <textarea class="input100" name="case_steps" placeholder="步骤*" aria-label="optional"\n' +
                                        '                              style="display: none"></textarea>\n' +
                                        '    </div>\n' +
                                        '    <div class="wrap-input100 validate-input" data-validate="Please enter case expectation">\n' +
                                        '                    <textarea class="input100" name="case_expectation" placeholder="期望结果*"\n' +
                                        '                              aria-label="expectation"></textarea>\n' +
                                        '    </div>\n' +
                                        '<label>\n' +
                                        '                    <select id="case_priority_value" class="custom-select" form="edit-case-form" name="case_priority">\n' +
                                        '                      <option value="H">High</option>\n' +
                                        '                      <option value="M">Middle</option>\n' +
                                        '                      <option value="L">Low</option>\n' +
                                        '                    </select>\n' +
                                        '                </label>' +
                                        '    <div class="container-contact100-form-btn">\n' +
                                        '        <button class="operations">\n' +
                                        '\t\t\t\t\t\t<span>\n' +
                                        '\t\t\t\t\t\t\t<i class="fa fa-paper-plane-o m-r-6" aria-hidden="true"></i>\n' +
                                        '\t\t\t\t\t\t\t保存\n' +
                                        '\t\t\t\t\t\t</span>\n' +
                                        '        </button>\n' +
                                        '    </div>\n' +
                                        '</form>';
                                    $("#case-detail-or-edit-or-new-case-form").append(data);
                                    $.ajax({
                                        type: "GET",
                                        url: "{% url 'case_detail' %}?pk=" + case_id + "&json_type=1",
                                        success: function (resultData) {
                                            var case_editor = editormd("steps", {
                                                width: "100%",
                                                height: 300,
                                                placeholder: "步骤*",
                                                toolbarIcons: function () {
                                                    return ["undo", "redo", "|", "bold", "hr", "|", "preview", "watch", "|", "list-ol", "list-ul", "link"]
                                                },
                                                markdown: resultData.msg.steps,
                                                path: "/static/js/editor.md-master/lib/"
                                            });
                                            $("input[name='case_title']").val(resultData.msg.title);
                                            $("textarea[name='case_desc']").val(resultData.msg.desc);
                                            $("textarea[name='case_preconditions']").val(resultData.msg.preconditions);
                                            $("textarea[name='case_expectation']").val(resultData.msg.expectation);
                                            $("#case_priority_value").val(resultData.msg.priority);
                                        },
                                        error: function () {
                                            layer.msg("服务器异常，请稍后再试!");
                                        }
                                    });
                                    $("form").submit(function (e) {
                                        e.preventDefault();
                                        let formData = new FormData(this);
                                        $.ajax({
                                            type: "POST",
                                            url: "{% url 'save_case' %}",
                                            data: formData,
                                            contentType: false,
                                            processData: false,
                                            dataType: 'json',
                                            success: function (resultData) {
                                                let result_message = resultData["msg"];
                                                let result_status = resultData["status"];
                                                if (result_status === 1) {
                                                    let case_detail_or_edit_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                                    if ($(case_detail_or_edit_form).length !== 0) {
                                                        $(case_detail_or_edit_form).remove();
                                                    }
                                                    let html_source = '<ol class="case_detail_ol">\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">标题</p>\n' +
                                                        '                                    <p class="case_detail_title"></p>\n' +
                                                        '                                </li>\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">描述</p>\n' +
                                                        '                                    <p class="case_detail_desc"></p>\n' +
                                                        '                                </li>\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">前提条件</p>\n' +
                                                        '                                    <p class="case_detail_preconditions">' +
                                                        '</p>' +
                                                        '                                </li>\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">步骤</p>\n' +
                                                        '                                    <p class="case_detail_p">\n' +
                                                        '                                    </p><div id="layout">\n' +
                                                        '                                    </div>\n' +
                                                        '                                    <p></p>\n' +
                                                        '                                </li>\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">期望结果</p>\n' +
                                                        '                                    <p class="case_detail_expectation"></p>\n' +
                                                        '                                </li>\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">优先级</p>\n' +
                                                        '                                    <p class="case_detail_priority"></p>\n' +
                                                        '                                </li>\n' +
                                                        '                            </ol>';
                                                    $("#case-detail-or-edit-or-new-case-form").append(html_source);
                                                    let data = resultData["data"];
                                                    $("#layout").append("<div id=\"case_detail_steps\" style=\"width: inherit;margin: 50px;\"></div>");
                                                    editormd.markdownToHTML("case_detail_steps", {//注意：这里是上面DIV的id
                                                        htmlDecode: "style,script,iframe",
                                                        emoji: true,
                                                        taskList: true,
                                                        tex: true, // 默认不解析
                                                        flowChart: true, // 默认不解析
                                                        sequenceDiagram: true, // 默认不解析
                                                        codeFold: true,
                                                        markdown: data.case_steps
                                                    });
                                                    $(".case_detail_title").text(data.case_title);
                                                    $(".case_detail_desc").text(data.case_desc);
                                                    $(".case_detail_preconditions").text(data.case_preconditions);
                                                    $(".case_detail_expectation").text(data.case_expectation);
                                                    $(".case_detail_priority").text(data.case_priority);
                                                    $("#all-case-tree").jstree('rename_node', $node, data.case_title);
                                                    layer.msg(result_message);
                                                } else {
                                                    layer.msg(result_message);
                                                }
                                            },
                                            error: function () {
                                                layer.msg("服务器异常，请稍后再试!");
                                            }
                                        })
                                    });
                                }
                            },
                            "delete": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "删除",
                                "icon": "/static/images/img/delete.png",
                                "action": function (obj) {
                                    let case_id = item_id.replace("case", "");
                                    layer.msg("确认删除此用例吗?", {
                                        btn: ["确认", "取消"],
                                        time: 0,
                                        yes: function () {
                                            $.ajax({
                                                type: "DELETE",
                                                url: "{% url 'remove_case' %}",
                                                data: {"pk": case_id},
                                                success: function (resultData) {
                                                    let result_message = resultData["msg"];
                                                    layer.msg(result_message);
                                                    let result_status = resultData["status"];
                                                    if (result_status === 1) {
                                                        window.location.href = "{% url 'list_case' %}";
                                                    }
                                                },
                                                error: function () {
                                                    layer.msg("服务器异常，请稍后再试!");
                                                }
                                            });
                                        }
                                    })
                                }
                            },
                        };
                    } else if (item_id.includes("module")) {
                        let module_id = item_id.replace("module", "");
                        return {
                            "New": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "新建",
                                "icon": "/static/images/img/add.png",
                                "submenu": {
                                    "case": {
                                        "separator_before": false,
                                        "separator_after": false,
                                        "label": "用例",
                                        "icon": "/static/images/img/tree-leaf.png",
                                        "action": function (obj) {
                                            let case_detail_or_edit_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                            if ($(case_detail_or_edit_form).length !== 0) {
                                                $(case_detail_or_edit_form).remove();
                                            }
                                            let html_source = '' +
                                                '<form class="contact100-form validate-form" enctype="multipart/form-data" id="new-case-form">\n' +
                                                '<input type="hidden" name="module_pk" value="' + module_id + '">' +
                                                '                    <div class="wrap-input100 validate-input" data-validate="Please enter case title">\n' +
                                                '                        <input class="input100" type="text" name="case_title" placeholder="标题*">\n' +
                                                '                        \n' +
                                                '                    </div>\n' +
                                                '                    <div class="wrap-input100 validate-input">\n' +
                                                '                    <textarea class="input100" name="case_desc" placeholder="描述"\n' +
                                                '                              aria-label="optional"></textarea>\n' +
                                                '                        \n' +
                                                '                    </div>\n' +
                                                '                    <div class="wrap-input100">\n' +
                                                '                    <textarea class="input100" name="case_preconditions" placeholder="前提条件"\n' +
                                                '                              aria-label="preconditions"></textarea>\n' +
                                                '                        \n' +
                                                '                    </div>\n' +
                                                '                    <div id="steps" data-validate="Please enter case steps">\n' +
                                                '                    <textarea class="input100" name="case_steps" placeholder="步骤*" aria-label="optional"\n' +
                                                '                              style="display: none"></textarea>\n' +
                                                '                    </div>\n' +
                                                '                    <div class="wrap-input100 validate-input" data-validate="Please enter case expectation">\n' +
                                                '                    <textarea class="input100" name="case_expectation" placeholder="期望结果*"\n' +
                                                '                              aria-label="expectation"></textarea>\n' +
                                                '                        \n' +
                                                '                    </div>\n' +
                                                '<label>\n' +
                                                '                    <select id="case_priority_value" class="custom-select" form="new-case-form" name="case_priority">\n' +
                                                '                      <option value="H">High</option>\n' +
                                                '                      <option value="M">Middle</option>\n' +
                                                '                      <option value="L">Low</option>\n' +
                                                '                    </select>\n' +
                                                '                </label>' +
                                                '                    <div class="container-contact100-form-btn">\n' +
                                                '                        <button class="operations">\n' +
                                                '\t\t\t\t\t\t<span>\n' +
                                                '\t\t\t\t\t\t\t<i class="fa fa-paper-plane-o m-r-6" aria-hidden="true"></i>\n' +
                                                '\t\t\t\t\t\t\t保存\n' +
                                                '\t\t\t\t\t\t</span>\n' +
                                                '                        </button>\n' +
                                                '                    </div>\n' +
                                                '                </form>';
                                            $("#case-detail-or-edit-or-new-case-form").append(html_source);
                                            var case_editor = editormd("steps", {
                                                width: "100%",
                                                height: 300,
                                                placeholder: "步骤*",
                                                toolbarIcons: function () {
                                                    return ["undo", "redo", "|", "bold", "hr", "|", "preview", "watch", "|", "list-ol", "list-ul", "link"]
                                                },
                                                path: "/static/js/editor.md-master/lib/"
                                            });
                                            $("form").submit(function (e) {
                                                e.preventDefault();
                                                let formData = new FormData(this);
                                                $.ajax({
                                                    type: "POST",
                                                    url: "{% url 'save_case' %}",
                                                    data: formData,
                                                    contentType: false,
                                                    processData: false,
                                                    dataType: 'json',
                                                    success: function (resultData) {
                                                        let result_message = resultData["msg"];
                                                        let result_status = resultData["status"];
                                                        if (result_status === 1) {
                                                            let case_detail_or_edit_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                                            if ($(case_detail_or_edit_form).length !== 0) {
                                                                $(case_detail_or_edit_form).remove();
                                                            }
                                                            let html_source = '<ol class="case_detail_ol">\n' +
                                                                '                                <li class="case_detail_li">\n' +
                                                                '                                    <p class="case_detail_h4">标题</p>\n' +
                                                                '                                    <p class="case_detail_title"></p>\n' +
                                                                '                                </li>\n' +
                                                                '                                <li class="case_detail_li">\n' +
                                                                '                                    <p class="case_detail_h4">描述</p>\n' +
                                                                '                                    <p class="case_detail_desc"></p>\n' +
                                                                '                                </li>\n' +
                                                                '                                <li class="case_detail_li">\n' +
                                                                '                                    <p class="case_detail_h4">前提条件</p>\n' +
                                                                '                                    <p class="case_detail_preconditions">' +
                                                                '</p>' +
                                                                '                                </li>\n' +
                                                                '                                <li class="case_detail_li">\n' +
                                                                '                                    <p class="case_detail_h4">步骤</p>\n' +
                                                                '                                    <p class="case_detail_p">\n' +
                                                                '                                    </p><div id="layout">\n' +
                                                                '                                    </div>\n' +
                                                                '                                    <p></p>\n' +
                                                                '                                </li>\n' +
                                                                '                                <li class="case_detail_li">\n' +
                                                                '                                    <p class="case_detail_h4">期望结果</p>\n' +
                                                                '                                    <p class="case_detail_expectation"></p>\n' +
                                                                '                                </li>\n' +
                                                                '                                <li class="case_detail_li">\n' +
                                                                '                                    <p class="case_detail_h4">优先级</p>\n' +
                                                                '                                    <p class="case_detail_priority"></p>\n' +
                                                                '                                </li>\n' +
                                                                '                            </ol>';
                                                            $("#case-detail-or-edit-or-new-case-form").append(html_source);
                                                            let data = resultData["data"];
                                                            $("#layout").append("<div id=\"case_detail_steps\" style=\"width: inherit;margin: 50px;\"></div>");
                                                            editormd.markdownToHTML("case_detail_steps", {//注意：这里是上面DIV的id
                                                                htmlDecode: "style,script,iframe",
                                                                emoji: true,
                                                                taskList: true,
                                                                tex: true, // 默认不解析
                                                                flowChart: true, // 默认不解析
                                                                sequenceDiagram: true, // 默认不解析
                                                                codeFold: true,
                                                                markdown: data.case_steps
                                                            });
                                                            $(".case_detail_title").text(data.case_title);
                                                            $(".case_detail_desc").text(data.case_desc);
                                                            $(".case_detail_preconditions").text(data.case_preconditions);
                                                            $(".case_detail_expectation").text(data.case_expectation);
                                                            $(".case_detail_priority").text(data.case_priority);
                                                            $("#all-case-tree").jstree('create_node', $node, {
                                                                "id": "case" + data.case_id,
                                                                "text": data.case_title,
                                                                "icon": "/static/images/img/tree-leaf.png"
                                                            }, "last", false, false);
                                                            layer.msg(result_message);

                                                        } else {
                                                            layer.msg(result_message);
                                                        }
                                                    },
                                                    error: function () {
                                                        layer.msg("服务器异常，请稍后再试!");
                                                    }
                                                })
                                            });
                                        }
                                    },
                                }
                            },
                            "edit": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "编辑",
                                "icon": "/static/images/img/edit.png",
                                "action": function (obj) {
                                    let case_detail_or_edit_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                    if ($(case_detail_or_edit_form).length !== 0) {
                                        $(case_detail_or_edit_form).remove();
                                    }
                                    let html_source = '<form class="contact100-form validate-form" method="post" action=""\n' +
                                        '                      enctype="multipart/form-data">\n' +
                                        '                    <div class="wrap-input100 validate-input" data-validate="Please enter module name">\n' +
                                        '                        <input class="input100" type="text" name="module_name" placeholder="模块名称*">\n' +
                                        '                        \n' +
                                        '                    </div>\n' +
                                        '<input type="hidden" name="module_pk" value="' + module_id + '">' +
                                        '                    <div class="container-contact100-form-btn">\n' +
                                        '                        <button class="operations">\n' +
                                        '\t\t\t\t\t\t<span>\n' +
                                        '\t\t\t\t\t\t\t<i class="fa fa-paper-plane-o m-r-6" aria-hidden="true"></i>\n' +
                                        '\t\t\t\t\t\t\t保存\n' +
                                        '\t\t\t\t\t\t</span>\n' +
                                        '                        </button>\n' +
                                        '                    </div>\n' +
                                        '                </form>';
                                    $("#case-detail-or-edit-or-new-case-form").append(html_source);
                                    $.ajax({
                                        type: "GET",
                                        url: "{% url 'module' %}",
                                        data: {"pk": module_id},
                                        success: function (resultData) {
                                            let result_status = resultData["status"];
                                            if (result_status === 1) {
                                                $("input[name='module_name']").val(resultData.data.module_name);
                                            }
                                        },
                                        error: function () {
                                            layer.msg("服务器异常，请稍后再试!");
                                        }
                                    });
                                    $("form").submit(function (e) {
                                        e.preventDefault();
                                        let formData = new FormData(this);
                                        $.ajax({
                                            type: "POST",
                                            url: "{% url 'module' %}",
                                            data: formData,
                                            contentType: false,
                                            processData: false,
                                            dataType: 'json',
                                            success: function (resultData) {
                                                let result_message = resultData["msg"];
                                                let result_status = resultData["status"];
                                                layer.msg(result_message);
                                                if (result_status === 1) {
                                                    let case_detail_or_edit_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                                    if ($(case_detail_or_edit_form).length !== 0) {
                                                        $(case_detail_or_edit_form).remove();
                                                    }
                                                    let html_source = '<ol class="module_detail_ol">\n' +
                                                        '                                <li class="module_detail_li">\n' +
                                                        '                                    <p class="module_detail_h4">模块</p>\n' +
                                                        '                                    <p class="module_detail_name"></p>\n' +
                                                        '                                </li>\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="module_detail_h4">用例数</p>\n' +
                                                        '                                    <p class="module_detail_case_count"></p>\n' +
                                                        '                                </li>\n' +
                                                        '                            </ol>';
                                                    $("#case-detail-or-edit-or-new-case-form").append(html_source);
                                                    $(".module_detail_name").text(resultData.data.module_name);
                                                    $(".module_detail_case_count").text(resultData.data.case_count);
                                                    $("#all-case-tree").jstree('rename_node', $node, resultData.data.module_name);
                                                }
                                            },
                                            error: function () {
                                                layer.msg("服务器异常，请稍后再试!");
                                            }
                                        })
                                    });
                                }
                            },
                            "info": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "详情",
                                "icon": "/static/images/img/info.png",
                                "action": function (obj) {
                                    $.ajax({
                                        type: "GET",
                                        url: "{% url 'module' %}?pk=" + module_id,
                                        success: function (resultData) {
                                            let result_status = resultData["status"];
                                            if (result_status === 1) {
                                                let case_detail_or_edit_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                                if ($(case_detail_or_edit_form).length !== 0) {
                                                    $(case_detail_or_edit_form).remove();
                                                }
                                                let html_source = '<ol class="module_detail_ol">\n' +
                                                    '                                <li class="module_detail_li">\n' +
                                                    '                                    <p class="module_detail_h4">模块</p>\n' +
                                                    '                                    <p class="module_detail_name"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                                <li class="module_detail_li">\n' +
                                                    '                                    <p class="module_detail_h4">用例数</p>\n' +
                                                    '                                    <p class="module_detail_case_count"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                            </ol>';
                                                $("#case-detail-or-edit-or-new-case-form").append(html_source);
                                                $(".module_detail_name").text(resultData.data.module_name);
                                                $(".module_detail_case_count").text(resultData.data.case_count);
                                                $("#all-case-tree").jstree('rename_node', $node, resultData.data.module_name);
                                            }
                                        },
                                        error: function () {
                                            layer.msg("服务器异常，请稍后再试!");
                                        }
                                    })
                                }
                            },
                            "delete": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "删除",
                                "icon": "/static/images/img/delete.png",
                                "action": function (obj) {
                                    layer.msg("该模块下所有用例将会被删除<br>确认删除此模块吗?", {
                                        btn: ["确认", "取消"],
                                        time: 0,
                                        yes: function () {
                                            $.ajax({
                                                type: "DELETE",
                                                url: "{% url 'module' %}",
                                                data: {"pk": module_id},
                                                success: function (resultData) {
                                                    let result_message = resultData["msg"];
                                                    layer.msg(result_message);
                                                    let result_status = resultData["status"];
                                                    if (result_status === 1) {
                                                        window.location.href = "{% url 'list_case' %}";
                                                    }
                                                },
                                                error: function () {
                                                    layer.msg("服务器异常，请稍后再试!");
                                                }
                                            });
                                        }
                                    })
                                }
                            },
                        }
                    } else if (item_id.includes("project")) {
                        let project_id = item_id.replace("project", "");
                        return {
                            "New": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "新建",
                                "icon": "/static/images/img/add.png",
                                "submenu": {
                                    "module": {
                                        "separator_before": false,
                                        "separator_after": false,
                                        "label": "模块",
                                        "icon": "/static/images/img/tree-module.png",
                                        "action": function (obj) {
                                            let case_detail_or_edit_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                            if ($(case_detail_or_edit_form).length !== 0) {
                                                $(case_detail_or_edit_form).remove();
                                            }
                                            let html_source = '<form class="contact100-form validate-form" method="post" action=""\n' +
                                                '                      enctype="multipart/form-data">\n' +
                                                '                    <div class="wrap-input100 validate-input" data-validate="Please enter module name">\n' +
                                                '                        <input class="input100" type="text" name="module_name" placeholder="模块名称*">\n' +
                                                '                        \n' +
                                                '                    </div>\n' +
                                                '<input type="hidden" name="project_pk" value="' + project_id + '">' +
                                                '                    <div class="container-contact100-form-btn">\n' +
                                                '                        <button class="operations">\n' +
                                                '\t\t\t\t\t\t<span>\n' +
                                                '\t\t\t\t\t\t\t<i class="fa fa-paper-plane-o m-r-6" aria-hidden="true"></i>\n' +
                                                '\t\t\t\t\t\t\t保存\n' +
                                                '\t\t\t\t\t\t</span>\n' +
                                                '                        </button>\n' +
                                                '                    </div>\n' +
                                                '                </form>';
                                            $("#case-detail-or-edit-or-new-case-form").append(html_source);
                                            $("form").submit(function (e) {
                                                e.preventDefault();
                                                let formData = new FormData(this);
                                                $.ajax({
                                                    type: "POST",
                                                    url: "{% url 'module' %}",
                                                    data: formData,
                                                    contentType: false,
                                                    processData: false,
                                                    dataType: 'json',
                                                    success: function (resultData) {
                                                        let result_message = resultData["msg"];
                                                        let result_status = resultData["status"];
                                                        let data = resultData["data"];
                                                        layer.msg(result_message);
                                                        if (result_status === 1) {
                                                            let case_detail_or_edit_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                                            if ($(case_detail_or_edit_form).length !== 0) {
                                                                $(case_detail_or_edit_form).remove();
                                                            }
                                                            let html_source = '<ol class="module_detail_ol">\n' +
                                                                '                                <li class="module_detail_li">\n' +
                                                                '                                    <p class="module_detail_h4">模块</p>\n' +
                                                                '                                    <p class="module_detail_name"></p>\n' +
                                                                '                                </li>\n' +
                                                                '                                <li class="module_detail_li">\n' +
                                                                '                                    <p class="module_detail_h4">用例数</p>\n' +
                                                                '                                    <p class="module_detail_case_count"></p>\n' +
                                                                '                                </li>\n' +
                                                                '                            </ol>';
                                                            $("#case-detail-or-edit-or-new-case-form").append(html_source);
                                                            $(".module_detail_name").text(resultData.data.module_name);
                                                            $(".module_detail_case_count").text(resultData.data.case_count);
                                                            $("#all-case-tree").jstree('create_node', $node, {
                                                                "id": "module" + data.module_id,
                                                                "text": data.module_name,
                                                                "icon": "/static/images/img/tree-module.png"
                                                            }, "last", false, false);
                                                        }
                                                    },
                                                    error: function () {
                                                        layer.msg("服务器异常，请稍后再试!");
                                                    }
                                                })
                                            });

                                        }
                                    },
                                }
                            },
                            "Detail": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "详情",
                                "icon": "/static/images/img/info.png",
                                "action": function (obj) {
                                    $.ajax({
                                        type: "GET",
                                        url: "{% url 'project' %}?pk=" + project_id,
                                        success: function (resultData) {
                                            let result_status = resultData["status"];
                                            if (result_status === 1) {
                                                let case_detail_or_edit_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                                if ($(case_detail_or_edit_form).length !== 0) {
                                                    $(case_detail_or_edit_form).remove();
                                                }
                                                let html_source = '<ol class="project_detail_ol">\n' +
                                                    '                                <li class="project_detail_li">\n' +
                                                    '                                    <p class="project_detail_h4">项目</p>\n' +
                                                    '                                    <p class="project_detail_name"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                                <li class="project_detail_li">\n' +
                                                    '                                    <p class="project_detail_h4">描述</p>\n' +
                                                    '                                    <p class="project_detail_desc"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                                <li class="project_detail_li">\n' +
                                                    '                                    <p class="project_detail_h4">头像</p>\n' +
                                                    '                                    <p class="project_detail_project_avatar"><img src="" style="width:80px;height:80px;border-radius:40px"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                                <li class="project_detail_li">\n' +
                                                    '                                    <p class="project_detail_h4">用例数</p>\n' +
                                                    '                                    <p class="project_detail_case_count"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                            </ol>';
                                                $("#case-detail-or-edit-or-new-case-form").append(html_source);
                                                $(".project_detail_name").text(resultData.data.name);
                                                $(".project_detail_desc").text(resultData.data.desc);
                                                $(".project_detail_case_count").text(resultData.data.case_count);
                                                $(".project_detail_project_avatar>img").attr('src', resultData.data.avatar);
                                            }
                                        },
                                        error: function () {
                                            layer.msg("服务器异常，请稍后再试!");
                                        }
                                    })
                                }
                            },
                            "edit": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "编辑",
                                "icon": "/static/images/img/edit.png",
                                "action": function (obj) {
                                    $.ajax({
                                        type: "GET",
                                        url: "{% url 'project' %}?pk=" + project_id,
                                        success: function (resultData) {
                                            let result_status = resultData["status"];
                                            if (result_status === 1) {
                                                let case_detail_or_edit_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                                if ($(case_detail_or_edit_form).length !== 0) {
                                                    $(case_detail_or_edit_form).remove();
                                                }
                                                let html_source = '<form class="contact100-form validate-form" id="submit_form" enctype="multipart/form-data" method="post"\n' +
                                                    '                      >\n' +
                                                    '<input type="hidden" name="pk" value="' + project_id + '">' +
                                                    '<input type="hidden" name="json_type" value="' + project_id + '">' +
                                                    '                    <div class="wrap-input100 validate-input" data-validate="Please enter project name">\n' +
                                                    '                        <input class="input100" type="text" name="project_name" placeholder="project name *"\n' +
                                                    '                               value="">\n' +
                                                    '                    </div>\n' +
                                                    '                    <div class="wrap-input100 validate-input">\n' +
                                                    '                    <textarea class="input100" name="project_desc" placeholder="description"\n' +
                                                    '                              aria-label="optional"></textarea>\n' +
                                                    '                        \n' +
                                                    '                    </div>\n' +
                                                    '                    <div id="file_upload_div" class="file-upload-wrapper" data-text="Change avatar">\n' +
                                                    '                        <img src="" class="rounded-circle standard-image">\n' +
                                                    '                    </div>\n' +
                                                    '                    <input id="avatar" name="avatar" type="file" class="file-upload-field" value="">\n' +
                                                    '                    <div class="container-contact100-form-btn">\n' +
                                                    '                        <button class="operations">\n' +
                                                    '\t\t\t\t\t\t<span>\n' +
                                                    '\t\t\t\t\t\t\t<i class="fa fa-paper-plane-o m-r-6" aria-hidden="true"></i>\n' +
                                                    '\t\t\t\t\t\t\t保存\n' +
                                                    '\t\t\t\t\t\t</span>\n' +
                                                    '                        </button>\n' +
                                                    '                    </div>\n' +
                                                    '                </form>';
                                                $("#case-detail-or-edit-or-new-case-form").append(html_source);
                                                $("input[name='project_name']").val(resultData.data.name);
                                                $("textarea[name='project_desc']").text(resultData.data.desc);
                                                $("#file_upload_div>img").attr('src', resultData.data.avatar);
                                                $("form").submit(function (e) {
                                                    e.preventDefault();
                                                    let formData = new FormData(this);
                                                    $.ajax({
                                                        type: "POST",
                                                        url: "{% url 'project' %}",
                                                        data: formData,
                                                        contentType: false,
                                                        processData: false,
                                                        dataType: 'json',
                                                        success: function (resultData) {
                                                            let result_message = resultData["msg"];
                                                            let result_status = resultData["status"];
                                                            layer.msg(result_message);
                                                            if (result_status === 1) {
                                                                $.ajax({
                                                                    type: "GET",
                                                                    url: "{% url 'project' %}?pk=" + project_id,
                                                                    success: function (resultData) {
                                                                        let result_status = resultData["status"];
                                                                        if (result_status === 1) {
                                                                            let case_detail_or_edit_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                                                            if ($(case_detail_or_edit_form).length !== 0) {
                                                                                $(case_detail_or_edit_form).remove();
                                                                            }
                                                                            let html_source = '<ol class="project_detail_ol">\n' +
                                                                                '                                <li class="project_detail_li">\n' +
                                                                                '                                    <p class="project_detail_h4">项目</p>\n' +
                                                                                '                                    <p class="project_detail_name"></p>\n' +
                                                                                '                                </li>\n' +
                                                                                '                                <li class="project_detail_li">\n' +
                                                                                '                                    <p class="project_detail_h4">描述</p>\n' +
                                                                                '                                    <p class="project_detail_desc"></p>\n' +
                                                                                '                                </li>\n' +
                                                                                '                                <li class="project_detail_li">\n' +
                                                                                '                                    <p class="project_detail_h4">头像</p>\n' +
                                                                                '                                    <p class="project_detail_project_avatar"><img src="" style="width:80px;height:80px;border-radius:40px"></p>\n' +
                                                                                '                                </li>\n' +
                                                                                '                                <li class="project_detail_li">\n' +
                                                                                '                                    <p class="project_detail_h4">用例数</p>\n' +
                                                                                '                                    <p class="project_detail_case_count"></p>\n' +
                                                                                '                                </li>\n' +
                                                                                '                            </ol>';
                                                                            $("#case-detail-or-edit-or-new-case-form").append(html_source);
                                                                            $(".project_detail_name").text(resultData.data.name);
                                                                            $(".project_detail_desc").text(resultData.data.desc);
                                                                            $(".project_detail_case_count").text(resultData.data.case_count);
                                                                            $(".project_detail_project_avatar>img").attr('src', resultData.data.avatar);
                                                                            $("#all-case-tree").jstree('set_icon', $node, resultData.data.avatar_tree);
                                                                        }
                                                                    },
                                                                    error: function () {
                                                                        layer.msg("服务器异常，请稍后再试!");
                                                                    }
                                                                })
                                                            }

                                                        },
                                                        error: function () {
                                                            layer.msg("服务器异常，请稍后再试!");
                                                        }
                                                    })
                                                })

                                            }
                                        },
                                        error: function () {
                                            layer.msg("服务器异常，请稍后再试!");
                                        }
                                    })

                                }
                            },
                            "delete": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "删除",
                                "icon": "/static/images/img/delete.png",
                                "action": function (obj) {
                                    layer.msg("确认删除此项目吗?", {
                                        btn: ["确认", "取消"],
                                        time: 0,
                                        yes: function () {
                                            layer.msg("所有用例将会被删除!!!<br>真的要删除它?", {
                                                btn: ["我确定", "取消"],
                                                time: 0,
                                                yes: function () {
                                                    $.ajax({
                                                        type: "DELETE",
                                                        url: "{% url 'project' %}",
                                                        data: {"pk": project_id},
                                                        success: function (resultData) {
                                                            let result_message = resultData["msg"];
                                                            layer.msg(result_message);
                                                            let result_status = resultData["status"];
                                                            if (result_status === 1) {
                                                                window.location.href = "{% url 'list_case' %}";
                                                            }
                                                        },
                                                        error: function () {
                                                            layer.msg("服务器异常，请稍后再试!");
                                                        }
                                                    });
                                                }
                                            })
                                        }
                                    })
                                }
                            },
                        }
                    }
                }
            },
        });
        let to = false;
        $('#search_node').keyup(function () {
            if (to) {
                clearTimeout(to);
            }
            to = setTimeout(function () {
                let v = $('#search_node').val();
                $('#all-case-tree').jstree(true).search(v);
            }, 250);
        });
    </script>
    <script type="application/javascript">
        $("#associate-task").on("click", function () {
            layer.open({
                type: 2,
                area: ['400px', '300px'],
                fixed: false, //不固定
                maxmin: true,
                title: "添加用例到测试任务",
                content: "{% url 'task' %}",
            });
        });

        function close_pop() {
            layer.closeAll();
        }

        function associate_task(task, plan, executor) {
            let cases = [];
            let cases_array = $("#all-case-tree").jstree("get_selected");
            for (let i = 0; i < cases_array.length; i++) {
                let case_i = cases_array[i];
                if (case_i.includes("case")) {
                    let c = case_i.replace("case", "");
                    cases.push(c);
                }
            }
            if (cases.length === 0) {
                layer.msg("请至少选择一个测试用例");
            } else {
                $.ajax({
                    type: "POST",
                    url: "{% url 'plan_associate' %}",
                    data: {"plan": plan, "task": task, "user": executor, "cases": JSON.stringify(cases)},
                    beforeSend: showLoadingAndHideIframe(),
                    success: function (resultData) {
                        layer.closeAll();
                        let result_message = resultData["msg"];
                        layer.msg(result_message);

                    },
                    error: function () {
                        layer.msg("服务器异常，请稍后再试!");
                    }
                })
            }
        }
    </script>
{% endblock %}