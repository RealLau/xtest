{% extends "Base/base.html" %}

{% block added_header %}
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="/static/css/animate.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="/static/css/hamburgers.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="/static/css/animsition.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="/static/css/select2.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="/static/css/daterangepicker.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="/static/css/util.css">
    <link rel="stylesheet" type="text/css" href="/static/css/main.css">
    <link rel="stylesheet" type="text/css" href="/static/css/file_upload.css">
    <link rel="stylesheet" type="text/css" href="/static/js/editor.md-master/css/editormd.min.css">

{% endblock %}
{% block main_content %}
    <div class="custom-main">
        <div class="wrap-contact100">
            {% if item == "1" %}
                <form class="contact100-form validate-form" id="submit_form" enctype="multipart/form-data" method="post"
                      action="{% url 'project' %}">
                    {% csrf_token %}
                    <div class="wrap-input100 validate-input" data-validate="Please enter project name">
                        <input class="input100" type="text" name="project_name" placeholder="project name *"
                               value="{{ edit_object.name }}">
                        <input type="text" name="pk" style="display: none" value="{{ edit_object.pk }}"/>
                        
                    </div>
                    <div class="wrap-input100 validate-input">
                    <textarea class="input100" name="project_desc" placeholder="description"
                              aria-label="optional">{{ edit_object.desc }}</textarea>
                        
                    </div>
                    <div id="file_upload_div" class="file-upload-wrapper" data-text="Change avatar">
                        <img src="{{ edit_object.avatar_url }}" class="rounded-circle standard-image">
                    </div>
                    <input id="avatar" name="avatar" type="file" class="file-upload-field" value="">
                    <div class="container-contact100-form-btn">
                        <button class="contact100-form-btn">
						<span>
							<i class="fa fa-paper-plane-o m-r-6" aria-hidden="true"></i>
							保存
						</span>
                        </button>
                    </div>
                </form>
            {% elif item == "2" %}
                <form class="contact100-form validate-form" method="post" action="{% url 'module' pk=edit_object.pk %}"
                      enctype="multipart/form-data">
                    <div class="wrap-input100 validate-input" data-validate="Please enter module name">
                        <input class="input100" type="text" name="module_name" placeholder="module name *"
                               value="{{ edit_object.name }}">
                        
                    </div>
                    <div class="project_selector">
                        <div class="project_select">
                            <span>{{ edit_object.project.name }}</span>
                        </div>
                        <input type="hidden" name="project" value="{{ edit_object.project.pk }}">
                        <input type="text" name="module_pk" style="display:none;" value="{{ edit_object.pk }}"/>
                        <ul class="project-custom-dropdown-menu" style="display: none">
                            {% for p in projects %}
                                <li id="{{ p.pk }}">{{ p.name }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% csrf_token %}
                    <div class="container-contact100-form-btn">
                        <button class="contact100-form-btn">
						<span>
							<i class="fa fa-paper-plane-o m-r-6" aria-hidden="true"></i>
							保存
						</span>
                        </button>
                    </div>
                </form>
            {% elif item == "4" %}
                <form class="contact100-form validate-form" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="module_selector">
                        <div class="select">
                            <span>{{ edit_object.module.name }}</span>
                        </div>
                        <input type="hidden" name="module" value="{{ edit_object.module.pk }}">
                        <ul class="custom-dropdown-menu" style="display: none">
                            {% for m in modules %}
                                <li id="{{ m.pk }}">{{ m.name }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="wrap-input100 validate-input" data-validate="Please enter case title">
                        <input type="text" value="{{ edit_object.pk }}" name="pk" style="display: none"/>
                        <input class="input100" type="text" name="case_title" placeholder="{{ item }} title *"
                               value="{{ edit_object.title }}">
                        
                    </div>
                    <div class="wrap-input100 validate-input">
                    <textarea class="input100" name="case_desc" placeholder="description"
                              aria-label="optional">{{ edit_object.desc }}</textarea>
                        
                    </div>
                    <div class="wrap-input100 validate-input">
                    <textarea class="input100" name="case_preconditions" placeholder="preconditions"
                              aria-label="preconditions">{{ edit_object.preconditions }}</textarea>
                        
                    </div>
                    <div id="steps">
                    <textarea class="input100" name="case_steps" placeholder="steps" aria-label="optional"
                              style="display: none">{{ edit_object.steps }}</textarea>
                    </div>
                    <div class="wrap-input100 validate-input">
                    <textarea class="input100" name="case_expectation" placeholder="expectation *"
                              aria-label="expectation">{{ edit_object.expectation }}</textarea>
                        
                    </div>
                    <div class="priority_selector">
                        <div class="priority_select">
                            <span>{{ edit_object.get_priority_display }}</span>
                        </div>
                        <input type="hidden" name="case_priority"  value="{{ edit_object.priority }}">
                        <ul class="priority-custom-dropdown-menu" style="display: none">
                            <li id="H">High</li>
                            <li id="M">Middle</li>
                            <li id="L">Low</li>
                        </ul>
                    </div>
                    <div class="container-contact100-form-btn">
                        <button class="contact100-form-btn">
						<span>
							<i class="fa fa-paper-plane-o m-r-6" aria-hidden="true"></i>
							保存
						</span>
                        </button>
                    </div>
                </form>
            {% endif %}

        </div>
    </div>

{% endblock %}

{% block added_script %}

    <script src="/static/js/animsition.min.js"></script>
    <!--===============================================================================================-->
    <script src="/static/js/js/popper.js"></script>
    <!--===============================================================================================-->
    <script src="/static/js/select2.min.js"></script>
    <!--===============================================================================================-->
    <script src="/static/js/daterangepicker.js"></script>
    <!--===============================================================================================-->
    <script src="/static/js/countdowntime.js"></script>
    <!--===============================================================================================-->
    <script src="/static/js/form.js"></script>
    {% if item == "4" %}
        <script src="/static/js/editor.md-master/editormd.min.js"></script>
    {% endif %}
    <script type="application/javascript">

        $(".file-upload-wrapper").on("click", function () {
            $("input[name='avatar']").click();
        });
        $("form").on("change", ".file-upload-field", function () {
            $("#file_upload_div").attr("data-text", $(this).val().replace(/.*([\/\\])/, ''));
        });
        {% if item == "4" or item == "1" %}
            {% if msg %}
                layer.msg("{{msg}}");
            {% endif %}
            $(".select").click(function () {
                let e = $(".custom-dropdown-menu");
                if ($(e).css("display") === "none") {
                    $(e).css("display", "block");
                } else {
                    $(e).css("display", "none");
                }
            });
            $(".priority_select").click(function () {
                let e = $(".priority-custom-dropdown-menu");
                if ($(e).css("display") === "none") {
                    $(e).css("display", "block");
                } else {
                    $(e).css("display", "none");
                }
            });

            $("body").click(function (e) {
                let selection_icon = $(".select,.priority_select");
                let submenu = $(".custom-dropdown-menu, .priority-custom-dropdown-menu");
                if (e.target === $(selection_icon)[0] && $($(submenu)[0]).is(':visible') || (e.target === $(selection_icon)[1] && $($(submenu)[1]).is(':visible'))) {
                    $(submenu).css("display", "block");
                } else {
                    $(submenu).css("display", "none");
                }
            });

            $('.module_selector .custom-dropdown-menu li').click(function () {
                $(this).parents('.module_selector').find('span').text($(this).text());
                $(this).parents('.module_selector').find('input').attr('value', $(this).attr('id'));
            });
            $('.priority_selector .priority-custom-dropdown-menu li').click(function () {
                $(this).parents('.priority_selector').find('span').text($(this).text());
                $(this).parents('.priority_selector').find('input').attr('value', $(this).attr('id'));
            });
            {% if item == "4" %}
                $(function () {
                    var case_editor = editormd("steps", {
                        width: "100%",
                        height: 300,
                        placeholder: "steps *",
                        toolbarIcons: function () {
                            return ["undo", "redo", "|", "bold", "hr", "|", "preview", "watch", "|", "list-ol", "list-ul", "link"]
                        },
                        path: "/static/js/editor.md-master/lib/"
                    });
                });
                $("form").submit(function (e) {
                    e.preventDefault();
                    let formData = new FormData(this);
                    $.ajax({
                        type: "POST",
                        url: "{% url 'save_case' %}",
                        data: formData,
                        contentType: false,
                        processData: false,
                        dataType: 'json',
                        success: function (resultData) {
                            let result_message = resultData["msg"];
                            let result_status = resultData["status"];
                            if (result_status === 1) {
                                let new_case_pk = resultData["new_case_pk"];
                                layer.confirm(result_message, {
                                    btn: ['创建新用例', '查看此用例'] //按钮
                                }, function () {
                                    window.location.href = "{% url 'new' item='4' %}";

                                }, function () {
                                    window.location.href = "/case_detail/?pk=" + new_case_pk;
                                });
                            }
                        },
                        error: function () {
                            layer.msg("服务器异常，请稍后再试!");
                        }
                    })
                });
            {% endif %}
        {% elif item == "2" %}
            $(".project_select").click(function () {
                let e = $(".project-custom-dropdown-menu");
                if ($(e).css("display") === "none") {
                    $(e).css("display", "block");
                } else {
                    $(e).css("display", "none");
                }
            });
            $("body").click(function (e) {
                let selection_icon = $(".project_select");
                let submenu = $(".project-custom-dropdown-menu");
                if (e.target === $(selection_icon)[0] && $($(submenu)).is(':visible')) {
                    $(submenu).css("display", "block");
                } else {
                    $(submenu).css("display", "none");
                }
            });
            $('.project_selector .project-custom-dropdown-menu li').click(function () {
                $(this).parents('.project_selector').find('span').text($(this).text());
                $(this).parents('.project_selector').find('input').attr('value', $(this).attr('id'));
            });
        {% endif %}
    </script>
{% endblock %}