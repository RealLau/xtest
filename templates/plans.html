{% extends "Base/base.html" %}
{% block added_header %}
    <link rel="stylesheet" href="/static/js/jstree/dist/themes/default/style.min.css"/>
    <link rel="stylesheet" type="text/css" href="/static/css/main.css">
    <link rel="stylesheet" type="text/css" href="/static/js/editor.md-master/css/editormd.min.css">
    <link href="/static/js/dist/rome.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/costom.css">
{% endblock %}
{% block main_content %}
    <div class="center-div">
        <label>
            <input class="search_node" type="text" name="search_text" placeholder="搜索" id="search_node">
        </label>
    </div>
    <div class="custom-main">
        <table style="width: 100%; height: 800px">
            <thead>
            <th>
                全部计划
            </th>
            <th>
                详情
            </th>
            </thead>
            <tr>
                <td>
                    <div id="all-plan-tree" class="execution-tree"></div>
                </td>
                <td style="width: 600px;height: 800px">
                    <div class="col-12 tm-block-col">
                        <div class="tm-bg-primary-dark tm-block tm-block-taller tm-block-scroll max-height execution-case-detail"
                             id="plan-task-case-form">
                            {% csrf_token %}
                        </div>
                    </div>
                </td>
            </tr>
        </table>
    </div>
{% endblock %}
{% block added_script %}
    <script src="/static/js/jstree/dist/jstree.min.js"></script>
    <script src="/static/js/editor.md-master/lib/marked.min.js"></script>
    <script src="/static/js/editor.md-master/lib/prettify.min.js"></script>
    <script src="/static/js/editor.md-master/lib/raphael.min.js"></script>
    <script src="/static/js/editor.md-master/lib/underscore.min.js"></script>
    <script src="/static/js/editor.md-master/lib/sequence-diagram.min.js"></script>
    <script src="/static/js/editor.md-master/lib/flowchart.min.js"></script>
    <script src="/static/js/editor.md-master/lib/jquery.flowchart.min.js"></script>
    <script src="/static/js/editor.md-master/editormd.min.js"></script>
    <script src="/static/js/select2.min.js"></script>
    <script src="/static/js/daterangepicker.js"></script>
    <script src="/static/js/countdowntime.js"></script>
    <script src="/static/js/dist/rome.js"></script>

    <script type="application/javascript">
        let csrftoken = Cookies.get('csrftoken');
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
                layer.load(0, {shade: false});
            }
        });
        let data = '{{ all_data|escapejs }}';
        let parsedData = JSON.parse(unescape(data.replace(/\\u/g, '%u')));
        $('#all-plan-tree').jstree({
            'core': {
                'data': parsedData,
                'check_callback': true,
            },
            "plugins": [
                "dnd", "search",
                "state", "types", "contextmenu",
            ],
            "contextmenu": {
                "items": function ($node) {
                    let item_id = $node.id;
                    console.log(item_id);
                    if ((item_id.includes("plan"))) {
                        let plan_id = item_id.replace("plan", "");
                        return {
                            "New": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "任务",
                                "icon": "/static/images/img/add.png",
                                "action": function (obj) {
                                    let case_detail_or_edit_form = $(".case_detail_ol,form, .select");
                                    if ($(case_detail_or_edit_form).length !== 0) {
                                        $(case_detail_or_edit_form).remove();
                                    }

                                    let steps_detail = $("#case_detail_steps");
                                    if ($(steps_detail).length !== 0) {
                                        $(steps_detail).remove();
                                    }
                                    let html_source = '<div class="select center-div" for="users">' +
                                        '<select id="users" name="users">' +
                                        '<option value="" selected disabled hidden>选择执行者</option>' +
                                        '</div>';
                                    $("#plan-task-case-form").append(html_source);
                                    $.ajax({
                                        type: "GET",
                                        url: "{% url 'users' %}",
                                        success: function (resultData) {
                                            layer.closeAll();
                                            let status = resultData.status;
                                            if(status===1){
                                                let result_data = resultData.data;
                                                for(let i=0;i<result_data.length;i++){
                                                    $("#users").append(new Option(result_data[i].name, result_data[i].id));
                                                }
                                            }
                                        },
                                        error: function () {
                                            layer.closeAll();
                                            layer.msg("服务器异常，请稍后再试!");
                                        }
                                    })
                                }
                            },
                            "Detail": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "详情",
                                "icon": "/static/images/img/info.png",
                                "action": function (obj) {
                                    $.ajax({
                                        type: "GET",
                                        url: "{% url 'plan' %}?pk=" + plan_id,
                                        success: function (resultData) {
                                            layer.closeAll();
                                            let result_data = resultData["data"];
                                            let status = resultData.status;
                                            if (status === 1) {
                                                let case_detail_or_edit_form = $(".case_detail_ol,form, .select");
                                                if ($(case_detail_or_edit_form).length !== 0) {
                                                    $(case_detail_or_edit_form).remove();
                                                }

                                                let steps_detail = $("#case_detail_steps");
                                                if ($(steps_detail).length !== 0) {
                                                    $(steps_detail).remove();
                                                }
                                                let html_source = '<ol class="case_detail_ol">\n' +
                                                    '                                <li class="case_detail_li">\n' +
                                                    '                                    <p class="case_detail_h4">代号</p>\n' +
                                                    '                                    <p class="case_detail_title"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                                <li class="case_detail_li">\n' +
                                                    '                                    <p class="case_detail_h4">用例总计</p>\n' +
                                                    '                                    <p class="case_detail_desc"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                                <li class="case_detail_li">\n' +
                                                    '                                    <p class="case_detail_h4">进度</p>\n' +
                                                    '                                    <p class="case_detail_preconditions">' +
                                                    '</p>' +
                                                    '                                </li>\n' +
                                                    '                                <li class="case_detail_li">\n' +
                                                    '                                    <p class="case_detail_h4">BUG总计</p>\n' +
                                                    '                                    <p class="case_detail_expectation"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                                <li class="case_detail_li">\n' +
                                                    '                                    <p class="case_detail_h4">参与者</p>\n' +
                                                    '                                    <p class="case_detail_priority"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                            </ol>';
                                                $("#plan-task-case-form").append(html_source);
                                                $(".case_detail_title").text(result_data.name);
                                                $(".case_detail_desc").text(result_data.cases);
                                                $(".case_detail_preconditions").text(result_data.process);
                                                $(".case_detail_expectation").text(result_data.bugs);
                                                $(".case_detail_priority").text(result_data.executors.join(", "));
                                            }

                                        },
                                        error: function () {
                                            layer.closeAll();
                                            layer.msg("服务器异常，请稍后再试!");
                                        }
                                    });
                                }
                            },
                            "edit": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "编辑",
                                "icon": "/static/images/img/edit.png",
                                "action": function (obj) {
                                    let plan_detail_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                    if ($(plan_detail_form).length !== 0) {
                                        $(plan_detail_form).remove();
                                    }

                                    let data = '<form class="contact100-form validate-form" enctype="multipart/form-data">' +
                                        '<input type=hidden name="pk" id="plan_pk">' +
                                        '                    <div class="wrap-input100 validate-input" data-validate="Please enter {{ item }} name">' +
                                        '                        {% csrf_token %}' +
                                        '                        <input class="input100" type="text" name="plan_name"' +
                                        '                               placeholder="代号*">' +
                                        '                        ' +
                                        '                    </div>' +
                                        '                    <div class="project_selector separate-line-bottom">' +
                                        '                        <label for="start_time">开始时间*</label>' +
                                        '                        <input id="start_time" name="start_time" class="time_input" autocomplete="off">' +
                                        '                        <label for="end_time" style="margin-left: 10px">结束时间*</label>' +
                                        '                        <input id="end_time" name="end_time" class="time_input" autocomplete="off">' +
                                        '                    </div>' +
                                        '                    <div class="center-div">' +
                                        '                        <button style="margin-top: 200px;background-color: #f5a623;padding: 0 20px;color: white;font-family: Ubuntu-Bold;">更新' +
                                        '                        </button>' +
                                        '                    </div>' +
                                        '                </form>';
                                    $("#plan-task-case-form").append(data);
                                    $.ajax({
                                        type: "GET",
                                        url: "{% url 'plan' %}?pk=" + plan_id,
                                        success: function (resultData) {
                                            layer.closeAll();
                                            let result_data = resultData["data"];
                                            let status = resultData.status;
                                            if (status === 1) {
                                                $("input[name='plan_name']").val(result_data.name);
                                                $("#plan_pk").val(plan_id);
                                                let plan_start_time = rome(start_time, options = {
                                                    "initialValue": result_data.start_time,
                                                    "required": true
                                                });
                                                let plan_end_time = rome(end_time, options = {
                                                    "initialValue": result_data.end_time,
                                                    "required": true
                                                });
                                            } else {
                                                layer.msg(resultData.msg);
                                            }

                                        },
                                        error: function () {
                                            layer.closeAll();
                                            layer.msg("服务器异常，请稍后再试!");
                                        }
                                    });

                                    $("form").submit(function (e) {
                                        e.preventDefault();
                                        let formData = new FormData(this);
                                        $.ajax({
                                            type: "POST",
                                            url: "{% url 'plan' %}",
                                            data: formData,
                                            contentType: false,
                                            processData: false,
                                            dataType: 'json',
                                            success: function (resultData) {
                                                layer.closeAll();
                                                let result_message = resultData["msg"];
                                                let result_status = resultData["status"];
                                                let result_data = resultData["data"];
                                                if (result_status === 1) {
                                                    let case_detail_or_edit_form = $(".case_detail_ol,form, .select");
                                                    if ($(case_detail_or_edit_form).length !== 0) {
                                                        $(case_detail_or_edit_form).remove();
                                                    }

                                                    let steps_detail = $("#case_detail_steps");
                                                    if ($(steps_detail).length !== 0) {
                                                        $(steps_detail).remove();
                                                    }
                                                    let html_source = '<ol class="case_detail_ol">\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">代号</p>\n' +
                                                        '                                    <p class="case_detail_title"></p>\n' +
                                                        '                                </li>\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">用例总计</p>\n' +
                                                        '                                    <p class="case_detail_desc"></p>\n' +
                                                        '                                </li>\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">进度</p>\n' +
                                                        '                                    <p class="case_detail_preconditions">' +
                                                        '</p>' +
                                                        '                                </li>\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">BUG总计</p>\n' +
                                                        '                                    <p class="case_detail_expectation"></p>\n' +
                                                        '                                </li>\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">参与者</p>\n' +
                                                        '                                    <p class="case_detail_priority"></p>\n' +
                                                        '                                </li>\n' +
                                                        '                            </ol>';
                                                    $("#plan-task-case-form").append(html_source);
                                                    $(".case_detail_title").text(result_data.name);
                                                    $(".case_detail_desc").text(result_data.cases);
                                                    $(".case_detail_preconditions").text(result_data.process);
                                                    $(".case_detail_expectation").text(result_data.bugs);
                                                    $(".case_detail_priority").text(result_data.executors.join(", "));
                                                    layer.msg("更新成功");
                                                } else {
                                                    layer.msg(result_message);
                                                }
                                            },
                                            error: function () {
                                                layer.msg("服务器异常，请稍后再试!");
                                            }
                                        })
                                    });
                                }
                            },
                            "delete": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "删除",
                                "icon": "/static/images/img/delete.png",
                                "action": function (obj) {
                                    let case_id = item_id.replace("case", "");
                                    layer.msg("确认删除此测试计划吗?", {
                                        btn: ["确认", "取消"],
                                        time: 0,
                                        yes: function () {
                                            $.ajax({
                                                type: "DELETE",
                                                url: "{% url 'plan' %}",
                                                data: {"pk": plan_id},
                                                success: function (resultData) {
                                                    let result_message = resultData["msg"];
                                                    layer.msg(result_message);
                                                    let result_status = resultData["status"];
                                                    if (result_status === 1) {
                                                        window.location.href = "{% url 'plan' %}";
                                                    }
                                                },
                                                error: function () {
                                                    layer.msg("服务器异常，请稍后再试!");
                                                }
                                            });
                                        }
                                    })
                                }
                            },
                        };
                    } else if ((item_id.includes("task"))) {
                        return {
                            "Detail": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "详情",
                                "icon": "/static/images/img/info.png",
                                "action": function (obj) {
                                    let task_id = item_id.replace("task", "");
                                    $.ajax({
                                        type: "GET",
                                        url: "{% url 'task' %}?pk=" + task_id,
                                        success: function (resultData) {
                                            layer.closeAll();
                                            let result_data = resultData["data"];
                                            let status = resultData.status;
                                            if (status === 1) {
                                                let case_detail_or_edit_form = $(".case_detail_ol,form, .select");
                                                if ($(case_detail_or_edit_form).length !== 0) {
                                                    $(case_detail_or_edit_form).remove();
                                                }

                                                let steps_detail = $("#case_detail_steps");
                                                if ($(steps_detail).length !== 0) {
                                                    $(steps_detail).remove();
                                                }
                                                let html_source = '<ol class="case_detail_ol">\n' +
                                                    '                                <li class="case_detail_li">\n' +
                                                    '                                    <p class="case_detail_h4">执行者</p>\n' +
                                                    '                                    <p class="case_detail_desc"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                                <li class="case_detail_li">\n' +
                                                    '                                    <p class="case_detail_h4">用例总计</p>\n' +
                                                    '                                    <p class="case_detail_preconditions">' +
                                                    '</p>' +
                                                    '                                </li>\n' +
                                                    '                                <li class="case_detail_li">\n' +
                                                    '                                    <p class="case_detail_h4">进度</p>\n' +
                                                    '                                    <p class="case_detail_expectation"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                                <li class="case_detail_li">\n' +
                                                    '                                    <p class="case_detail_h4">BUG总计</p>\n' +
                                                    '                                    <p class="case_detail_priority"></p>\n' +
                                                    '                                </li>\n' +
                                                    '                            </ol>';
                                                $("#plan-task-case-form").append(html_source);
                                                $(".case_detail_desc").text(result_data.executor);
                                                $(".case_detail_preconditions").text(result_data.cases);
                                                $(".case_detail_expectation").text(result_data.process);
                                                $(".case_detail_priority").text(result_data.bugs);
                                            }

                                        },
                                        error: function () {
                                            layer.closeAll();
                                            layer.msg("服务器异常，请稍后再试!");
                                        }
                                    });
                                }
                            },
                            "edit": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "编辑",
                                "icon": "/static/images/img/edit.png",
                                "action": function (obj) {
                                    let case_id = item_id.replace("case", "");
                                    let case_detail_or_edit_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                    if ($(case_detail_or_edit_form).length !== 0) {
                                        $(case_detail_or_edit_form).remove();
                                    }

                                    let data = '<form class="contact100-form validate-form" enctype="multipart/form-data" id="edit-case-form">\n' +
                                        '    <div class="wrap-input100 validate-input" data-validate="Please enter case title">\n' +
                                        '        <input class="input100" type="text" name="case_title" placeholder="标题*">\n' +
                                        '    </div>\n' +
                                        '<input class="input100" name="case_pk" type="hidden" value="' + case_id + '"' + '>' +
                                        '    <div class="wrap-input100 validate-input">\n' +
                                        '                    <textarea class="input100" name="case_desc" placeholder="描述"\n' +
                                        '                              aria-label="optional"></textarea>\n' +
                                        '    </div>\n' +
                                        '    <div class="wrap-input100">\n' +
                                        '                    <textarea class="input100" name="case_preconditions" placeholder="前提条件"\n' +
                                        '                              aria-label="preconditions"></textarea>\n' +
                                        '    </div>\n' +
                                        '    <div id="steps" data-validate="Please enter case steps">\n' +
                                        '                    <textarea class="input100" name="case_steps" placeholder="步骤*" aria-label="optional"\n' +
                                        '                              style="display: none"></textarea>\n' +
                                        '    </div>\n' +
                                        '    <div class="wrap-input100 validate-input" data-validate="Please enter case expectation">\n' +
                                        '                    <textarea class="input100" name="case_expectation" placeholder="期望结果*"\n' +
                                        '                              aria-label="expectation"></textarea>\n' +
                                        '    </div>\n' +
                                        '<label>\n' +
                                        '                    <select id="case_priority_value" class="custom-select" form="edit-case-form" name="case_priority">\n' +
                                        '                      <option value="H">High</option>\n' +
                                        '                      <option value="M">Middle</option>\n' +
                                        '                      <option value="L">Low</option>\n' +
                                        '                    </select>\n' +
                                        '                </label>' +
                                        '    <div class="container-contact100-form-btn">\n' +
                                        '        <button class="operations">\n' +
                                        '\t\t\t\t\t\t<span>\n' +
                                        '\t\t\t\t\t\t\t<i class="fa fa-paper-plane-o m-r-6" aria-hidden="true"></i>\n' +
                                        '\t\t\t\t\t\t\t保存\n' +
                                        '\t\t\t\t\t\t</span>\n' +
                                        '        </button>\n' +
                                        '    </div>\n' +
                                        '</form>';
                                    $("#case-detail-or-edit-or-new-case-form").append(data);
                                    $.ajax({
                                        type: "GET",
                                        url: "{% url 'case_detail' %}?pk=" + case_id + "&json_type=1",
                                        success: function (resultData) {
                                            var case_editor = editormd("steps", {
                                                width: "100%",
                                                height: 300,
                                                placeholder: "步骤*",
                                                toolbarIcons: function () {
                                                    return ["undo", "redo", "|", "bold", "hr", "|", "preview", "watch", "|", "list-ol", "list-ul", "link"]
                                                },
                                                markdown: resultData.msg.steps,
                                                path: "/static/js/editor.md-master/lib/"
                                            });
                                            $("input[name='case_title']").val(resultData.msg.title);
                                            $("textarea[name='case_desc']").val(resultData.msg.desc);
                                            $("textarea[name='case_preconditions']").val(resultData.msg.preconditions);
                                            $("textarea[name='case_expectation']").val(resultData.msg.expectation);
                                            $("#case_priority_value").val(resultData.msg.priority);
                                        },
                                        error: function () {
                                            layer.msg("服务器异常，请稍后再试!");
                                        }
                                    });
                                    $("form").submit(function (e) {
                                        e.preventDefault();
                                        let formData = new FormData(this);
                                        $.ajax({
                                            type: "POST",
                                            url: "{% url 'save_case' %}",
                                            data: formData,
                                            contentType: false,
                                            processData: false,
                                            dataType: 'json',
                                            success: function (resultData) {
                                                let result_message = resultData["msg"];
                                                let result_status = resultData["status"];
                                                if (result_status === 1) {
                                                    let case_detail_or_edit_form = $(".case_detail_ol, .module_detail_ol, .project_detail_ol, form");
                                                    if ($(case_detail_or_edit_form).length !== 0) {
                                                        $(case_detail_or_edit_form).remove();
                                                    }
                                                    let html_source = '<ol class="case_detail_ol">\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">标题</p>\n' +
                                                        '                                    <p class="case_detail_title"></p>\n' +
                                                        '                                </li>\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">描述</p>\n' +
                                                        '                                    <p class="case_detail_desc"></p>\n' +
                                                        '                                </li>\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">前提条件</p>\n' +
                                                        '                                    <p class="case_detail_preconditions">' +
                                                        '</p>' +
                                                        '                                </li>\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">步骤</p>\n' +
                                                        '                                    <p class="case_detail_p">\n' +
                                                        '                                    </p><div id="layout">\n' +
                                                        '                                    </div>\n' +
                                                        '                                    <p></p>\n' +
                                                        '                                </li>\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">期望结果</p>\n' +
                                                        '                                    <p class="case_detail_expectation"></p>\n' +
                                                        '                                </li>\n' +
                                                        '                                <li class="case_detail_li">\n' +
                                                        '                                    <p class="case_detail_h4">优先级</p>\n' +
                                                        '                                    <p class="case_detail_priority"></p>\n' +
                                                        '                                </li>\n' +
                                                        '                            </ol>';
                                                    $("#case-detail-or-edit-or-new-case-form").append(html_source);
                                                    let data = resultData["data"];
                                                    $("#layout").append("<div id=\"case_detail_steps\" style=\"width: inherit;margin: 50px;\"></div>");
                                                    editormd.markdownToHTML("case_detail_steps", {//注意：这里是上面DIV的id
                                                        htmlDecode: "style,script,iframe",
                                                        emoji: true,
                                                        taskList: true,
                                                        tex: true, // 默认不解析
                                                        flowChart: true, // 默认不解析
                                                        sequenceDiagram: true, // 默认不解析
                                                        codeFold: true,
                                                        markdown: data.case_steps
                                                    });
                                                    $(".case_detail_title").text(data.case_title);
                                                    $(".case_detail_desc").text(data.case_desc);
                                                    $(".case_detail_preconditions").text(data.case_preconditions);
                                                    $(".case_detail_expectation").text(data.case_expectation);
                                                    $(".case_detail_priority").text(data.case_priority);
                                                    $("#all-case-tree").jstree('rename_node', $node, data.case_title);
                                                    layer.msg(result_message);
                                                } else {
                                                    layer.msg(result_message);
                                                }
                                            },
                                            error: function () {
                                                layer.msg("服务器异常，请稍后再试!");
                                            }
                                        })
                                    });
                                }
                            },
                            "delete": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "删除",
                                "icon": "/static/images/img/delete.png",
                                "action": function (obj) {
                                    let case_id = item_id.replace("case", "");
                                    layer.msg("确认删除此用例吗?", {
                                        btn: ["确认", "取消"],
                                        time: 0,
                                        yes: function () {
                                            $.ajax({
                                                type: "DELETE",
                                                url: "{% url 'remove_case' %}",
                                                data: {"pk": case_id},
                                                success: function (resultData) {
                                                    let result_message = resultData["msg"];
                                                    layer.msg(result_message);
                                                    let result_status = resultData["status"];
                                                    if (result_status === 1) {
                                                        window.location.href = "{% url 'list_case' %}";
                                                    }
                                                },
                                                error: function () {
                                                    layer.msg("服务器异常，请稍后再试!");
                                                }
                                            });
                                        }
                                    })
                                }
                            },
                        };
                    }
                }
            }
        });
        let to = false;
        $('#search_node').keyup(function () {
            if (to) {
                clearTimeout(to);
            }
            to = setTimeout(function () {
                let v = $('#search_node').val();
                $('#all-plan-tree').jstree(true).search(v);
            }, 250);
        });
    </script>
{% endblock %}